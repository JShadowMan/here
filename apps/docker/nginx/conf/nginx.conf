# binding worker processes automatically to available CPUs
worker_processes     auto;
worker_cpu_affinity  auto;

# the directives that affect connection processing are specified
events {
    worker_connections  1024;
}

# http server
http {
    include  mime.types;
    default_type  application/octet-stream;

    server_tokens  off;

    sendfile  on;
    tcp_nopush  on;

    keepalive_timeout  65;
    gzip  on;

    server {
        listen  80;
        server_name  default;

        root  /var/www/public;
        index  index.php index.html;
        charset  utf-8;

        client_max_body_size 100M;
        fastcgi_read_timeout 1800;

        location / {
            try_files $uri $uri/ /index.php?_url=$uri&$args;
        }

        location ~ [^/]\.php(\/|$) {
            fastcgi_pass  php:9000;
            include  fastcgi.conf;

            fastcgi_index  index.php;
            fastcgi_param  PATH_INFO  $fastcgi_path_info;
        }

        location ~ /\.ht {
            deny all;
        }

        location ~* \.(js|css|png|jpg|jpeg|gif|ico)$ {
            expires       max;
            log_not_found off;
            access_log    off;
        }
    }
}

# stay in the foreground so Docker has a process to track
daemon off;
